{
  "name": "LINE_CHATBOT",
  "nodes": [
    {
      "parameters": {
        "modelName": "models/gemini-2.5-flash-preview-05-20",
        "options": {
          "temperature": 0.4
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        700,
        420
      ],
      "id": "b5ea9355-7989-4885-b01c-d4f341567bb4",
      "name": "Google Gemini (或其他 AI)",
      "credentials": {
        "googlePalmApi": {
          "id": "m3rIFo4KWXjpkCMd",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=# 主要任務\n分析用戶輸入內容：「{{ $json.body.events[0].message.text }}」\n\n## 內容判斷與處理邏輯\n\n### 技術相關內容處理\n**判斷標準**：包含技術文件、會議記錄、專業討論等內容\n**處理方式**：\n- 如內容包含網址，使用 \"HTTP Request\"或是\"Jina AI\" 工具讀取完整內容。若沒有正確爬取內容請回覆錯誤訊息。\n- 如內容包含youtube網址，使用\"Youtube Transcript\"工具讀取影片逐字稿。若沒有正確爬取內容請回覆錯誤訊息。\n- 一般情況依照「標準輸出模板」格式化回覆,\n- 若使用者要求詳細報告,則依照「詳細輸出模板」輸出\n- 內容與技術內容不相關，依照「非技術內容處理」輸出\n\n## 技術內容輸出規範\n\n### 基本要求\n- **語言**：繁體中文\n- **平台**：LINE 通訊軟體適配\n- **字數**：控制在 500 字以內\n- **格式**：純文字，避免 Markdown 和 HTML 語法\n\n### 標準輸出模板\n\n#### 標題區塊\n📋 {會議主題或內容標題}\n\n#### 內容結構（依序排列）\n\n**🎯 核心觀點**\n- 提煉主要論點和關鍵議題\n- 突出最重要的核心概念\n\n### 詳細輸出模板\n\n#### 標題區塊\n```\n📋 {會議主題或內容標題}\n\n```\n#### 內容結構（依序排列）\n\n**🎯 核心觀點**\n- 提煉主要論點和關鍵議題\n- 突出最重要的核心概念\n\n**📋 詳細內容**  \n- 整理重要討論點和關鍵資訊\n- 保持邏輯順序和完整脈絡\n\n**✅ 重要結論**\n- 歸納達成的共識和決議\n- 明確列出後續行動項目\n\n### 格式優化指引\n- 使用表情符號增強視覺效果和可讀性\n- 適當運用分隔線和空行提升結構清晰度\n- 針對手機閱讀體驗優化排版\n- 確保內容完整且邏輯清楚\n\n### 輸出限制\n❌ 禁止使用：Markdown 語法（#、**、[]()等）\n❌ 禁止使用：HTML 標籤\n❌ 禁止輸出：處理過程說明或額外註解\n✅ 僅輸出：最終整理完成的內容總結\n\n## 執行提醒\n- 基於提供的原始內容進行分析總結\n- 確保回覆內容準確且具有實用價值\n- 保持專業性的同時兼顧易讀性",
        "hasOutputParser": true,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        800,
        240
      ],
      "id": "2feca3e8-e0f5-4ea4-8fd7-b97b630f6efd",
      "name": "AI 語言模型"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.line.me/v2/bot/message/reply",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Authorization",
              "value": "Bearer uRqMFQ1KdVU79IOYm3svDPEctOSxF3ud1hDocb+tIw5D2w7nbEVEoUGSeQhQHf1h69pl2RP47ekJuLsHURRv7iRSvBJaT41Spm3gUKIZvWlHKOhA9EJZgzSal/c50gz3NPY+X1L19fKUL1q77I0dLgdB04t89/1O/w1cDnyilFU="
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"replyToken\": \"{{ $json.replyToken }}\",\n  \"messages\": [\n    {\n      \"type\": \"text\",\n      \"text\": \"{{ $json.text }}\"\n    }\n  ]\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1440,
        140
      ],
      "id": "d148138d-5be6-4b01-a1b4-0d01c71b263e",
      "name": "發送回應給 LINE"
    },
    {
      "parameters": {
        "jsCode": "// 確保數據存在並加入錯誤處理\ntry {\n  const replyTokenItem = items.find(item => item.json.body?.events?.[0]?.replyToken);\n  const outputItem = items.find(item => item.json.output);\n  \n  // 檢查必要數據是否存在\n  if (!replyTokenItem) {\n    throw new Error('找不到 replyToken 數據');\n  }\n  \n  if (!outputItem) {\n    throw new Error('找不到 output 數據');\n  }\n  \n  // 取得 replyToken 和 output\n  const replyToken = replyTokenItem.json.body.events[0].replyToken;\n  let text = outputItem.json.output;\n  \n  // 文字清理和格式化 - 保留換行符號\n  if (typeof text === 'string') {\n    text = text\n      .trim()                                    // 移除前後空白\n      .replace(/\\\\/g, '\\\\\\\\')                   // 先處理反斜線轉義\n      .replace(/\"/g, '\\\\\"')                     // 轉義雙引號\n      .replace(/'/g, \"\\\\'\")                     // 轉義單引號\n      .replace(/\\\\\\\\n/g, '\\n')                  // 將字面上的 \\\\n 轉換為真正的換行\n      .replace(/\\r\\n/g, '\\n')                   // 統一換行符號 (Windows)\n      .replace(/\\r/g, '\\n')                     // 統一換行符號 (Mac)\n      .replace(/\\t/g, '    ')                   // 將 tab 替換為 4 個空格\n      .replace(/[ \\f\\v]+/g, ' ')                // 多個空格、換頁符、垂直tab合併為一個空格\n      .replace(/\\n[ ]+/g, '\\n')                 // 移除換行後的多餘空格\n      .replace(/[ ]+\\n/g, '\\n')                 // 移除換行前的多餘空格\n      .replace(/\\n{3,}/g, '\\n\\n')               // 超過兩個連續換行合併為兩個\n      .replace(/[\\u0000-\\u0008\\u000B\\u000C\\u000E-\\u001F\\u007F]/g, '') // 移除控制字符但保留換行(\\n)和tab\n      .replace(/[\\u2028\\u2029]/g, '\\n')       // 處理 Unicode 行分隔符\n      .replace(/\\*\\*(.*?)\\*\\*/g, '$1');\n  }\n  \n  // 檢查文字長度限制 (LINE 限制 5000 字符)\n  if (text.length > 5000) {\n    // 在適當位置截斷，避免在單詞中間截斷\n    const truncated = text.substring(0, 4950);\n    const lastNewline = truncated.lastIndexOf('\\n');\n    const lastSpace = truncated.lastIndexOf(' ');\n    \n    // 選擇最近的自然分割點\n    const cutPoint = Math.max(lastNewline, lastSpace);\n    text = (cutPoint > 4900 ? truncated.substring(0, cutPoint) : truncated) + '\\n...(內容已截斷)';\n  }\n  \n  // 最終清理 - 確保開頭結尾沒有多餘換行，並進行 JSON 安全處理\n  text = text.replace(/^\\n+/, '').replace(/\\n+$/, '');\n  \n  // 額外的 JSON 安全處理\n  text = JSON.stringify(text).slice(1, -1); // 使用 JSON.stringify 然後移除前後引號\n  \n  // 回傳整理後的結果\n  return [\n    {\n      json: {\n        replyToken: replyToken,\n        text: text\n      }\n    }\n  ];\n} catch (error) {\n  // 錯誤處理\n  console.error('處理數據時發生錯誤:', error.message);\n  \n  // 回傳錯誤回應 (如果有 replyToken 的話)\n  const fallbackReplyToken = items.find(item => item.json.body?.events?.[0]?.replyToken)?.json.body.events[0].replyToken;\n  \n  if (fallbackReplyToken) {\n    return [\n      {\n        json: {\n          replyToken: fallbackReplyToken,\n          text: \"抱歉，處理您的訊息時發生錯誤，請稍後再試。\"\n        }\n      }\n    ];\n  }\n  \n  // 如果連 replyToken 都沒有，拋出錯誤\n  throw error;\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1300,
        140
      ],
      "id": "319724b9-e2a9-4fcd-b13e-6df39820e314",
      "name": "Code"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.1,
      "position": [
        1160,
        140
      ],
      "id": "67387018-1bc1-4995-a8f6-af17f85ba9be",
      "name": "Merge"
    },
    {
      "parameters": {
        "url": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('URL', ``, 'string') }}",
        "options": {},
        "requestOptions": {}
      },
      "type": "n8n-nodes-base.jinaAiTool",
      "typeVersion": 1,
      "position": [
        1080,
        560
      ],
      "id": "9d474a77-a70d-4276-a440-4a20fc19f930",
      "name": "Jina AI",
      "credentials": {
        "jinaAiApi": {
          "id": "ZmuJsTfIvReyvBPy",
          "name": "Jina AI account"
        }
      }
    },
    {
      "parameters": {
        "url": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('URL', ``, 'string') }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.2,
      "position": [
        960,
        560
      ],
      "id": "48447b56-30a5-46fd-aa0e-aa05ba55c443",
      "name": "HTTP Request"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "9e44df2e-2952-4a20-9fde-3771e82e5ff9",
              "leftValue": "={{$json[\"body\"][\"events\"][0][\"message\"][\"text\"]}}",
              "rightValue": "@ITR",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        560,
        140
      ],
      "id": "d11e0386-81f3-40fe-9078-acca33c6cad2",
      "name": "If"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "line-message",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        400,
        140
      ],
      "id": "3e20df60-b42d-4dfd-b13a-5434953f4f7e",
      "name": "Webhook 入口",
      "webhookId": "PLACEHOLDER-WEBHOOK-ID"
    },
    {
      "parameters": {
        "description": "Call this tool to get a youtube transcript",
        "workflowId": {
          "__rl": true,
          "value": "2sjWStiS9b6WOMsi",
          "mode": "list",
          "cachedResultName": "YT影片逐字稿"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "URL": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('URL', ``, 'string') }}"
          },
          "matchingColumns": [
            "URL"
          ],
          "schema": [
            {
              "id": "URL",
              "displayName": "URL",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        1240,
        540
      ],
      "id": "0667d9cb-994f-41a8-addb-cf4bfbac9a5e",
      "name": "Youtube Transcript"
    }
  ],
  "pinData": {},
  "connections": {
    "AI 語言模型": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Google Gemini (或其他 AI)": {
      "ai_languageModel": [
        [
          {
            "node": "AI 語言模型",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Code": {
      "main": [
        [
          {
            "node": "發送回應給 LINE",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Jina AI": {
      "ai_tool": [
        [
          {
            "node": "AI 語言模型",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request": {
      "ai_tool": [
        [
          {
            "node": "AI 語言模型",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "AI 語言模型",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook 入口": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Youtube Transcript": {
      "ai_tool": [
        [
          {
            "node": "AI 語言模型",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "48f2cfa3-3231-442c-9a23-1a1d5c774c07",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "fe071ad636e45e06fef1442bb4b3138ea8056f3019d720e9410a8f0ea42951a8"
  },
  "id": "Y7K0chYq48AtJYer",
  "tags": []
}