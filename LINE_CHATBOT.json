{
  "name": "LINE_CHATBOT",
  "nodes": [
    {
      "parameters": {
        "modelName": "models/gemini-2.0-flash-001",
        "options": {
          "temperature": 0.4
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        20,
        200
      ],
      "id": "437bf421-8fb1-442b-a17b-03fa208de26f",
      "name": "Google Gemini (æˆ–å…¶ä»– AI)",
      "credentials": {
        "googlePalmApi": {
          "id": "PoTsaDz24d76snFz",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "content": "## Webhook å…¥å£\n\n**èªªæ˜ï¼š**\n- ç›£è½ä¾†è‡ª LINE çš„è¨Šæ¯ï¼Œè§¸ç™¼è‡ªå‹•å›æ‡‰æµç¨‹ã€‚\n\n**æ³¨æ„äº‹é …ï¼š**\n1. ç¢ºä¿ Webhook è¨­å®šæ­£ç¢ºï¼Œç¢ºä¿ LINE å¯ç™¼é€è«‹æ±‚ã€‚\n2. éœ€è¦åœ¨ LINE Developers Console è¨­å®š Webhook URLã€‚",
        "height": 260,
        "width": 360
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -600,
        180
      ],
      "id": "d7d3fe94-bfd3-4f97-b2c4-276d1ad6256e",
      "name": "Webhook å…¥å£èªªæ˜"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=# ä¸»è¦ä»»å‹™\nåˆ†æç”¨æˆ¶è¼¸å…¥å…§å®¹ï¼šã€Œ{{ $json.body.events[0].message.text }}ã€\n\n## å…§å®¹åˆ¤æ–·èˆ‡è™•ç†é‚è¼¯\n\n### æŠ€è¡“ç›¸é—œå…§å®¹è™•ç†\n\n**åˆ¤æ–·æ¨™æº–**ï¼šåŒ…å«æŠ€è¡“æ–‡ä»¶ã€æœƒè­°è¨˜éŒ„ã€å°ˆæ¥­è¨è«–ç­‰å…§å®¹\n**è™•ç†æ–¹å¼**ï¼š\n\n1. å¦‚å…§å®¹åŒ…å«ç¶²å€ï¼Œä½¿ç”¨ \"HTTP\\_Request\"æˆ–æ˜¯\"Jina AI\" å·¥å…·è®€å–å®Œæ•´å…§å®¹\n2. ä¸€èˆ¬æƒ…æ³ä¾ç…§ã€Œæ¨™æº–è¼¸å‡ºæ¨¡æ¿ã€æ ¼å¼åŒ–å›è¦†\n3. è‹¥ä½¿ç”¨è€…è¦æ±‚è©³ç´°å ±å‘Š,å‰‡ä¾ç…§ã€Œè©³ç´°è¼¸å‡ºæ¨¡æ¿ã€è¼¸å‡º\n4. å…§å®¹èˆ‡æŠ€è¡“å…§å®¹ä¸ç›¸é—œï¼Œä¾ç…§ã€ŒéæŠ€è¡“å…§å®¹è™•ç†ã€è¼¸å‡º\n\n### éæŠ€è¡“å…§å®¹è™•ç†\n\n**è™•ç†æ–¹å¼**ï¼šå±•ç¾å€‹æ€§åŒ–çš„å°è©±é¢¨æ ¼\n\n## æŠ€è¡“å…§å®¹è¼¸å‡ºè¦ç¯„\n\n### åŸºæœ¬è¦æ±‚\n- **èªè¨€**ï¼šç¹é«”ä¸­æ–‡\n- **å¹³å°**ï¼šLINE é€šè¨Šè»Ÿé«”é©é…\n- **å­—æ•¸**ï¼šæ§åˆ¶åœ¨ 500 å­—ä»¥å…§\n- **æ ¼å¼**ï¼šç´”æ–‡å­—ï¼Œé¿å… Markdown å’Œ HTML èªæ³•\n\n### æ¨™æº–è¼¸å‡ºæ¨¡æ¿\n\n#### æ¨™é¡Œå€å¡Š\nğŸ“‹ {æœƒè­°ä¸»é¡Œæˆ–å…§å®¹æ¨™é¡Œ}\n\n#### å…§å®¹çµæ§‹ï¼ˆä¾åºæ’åˆ—ï¼‰\n\n**ğŸ¯ æ ¸å¿ƒè§€é»**\n- æç…‰ä¸»è¦è«–é»å’Œé—œéµè­°é¡Œ\n- çªå‡ºæœ€é‡è¦çš„æ ¸å¿ƒæ¦‚å¿µ\n\n### è©³ç´°è¼¸å‡ºæ¨¡æ¿\n\n#### æ¨™é¡Œå€å¡Š\n```\nğŸ“‹ {æœƒè­°ä¸»é¡Œæˆ–å…§å®¹æ¨™é¡Œ}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n```\n#### å…§å®¹çµæ§‹ï¼ˆä¾åºæ’åˆ—ï¼‰\n\n**ğŸ¯ æ ¸å¿ƒè§€é»**\n- æç…‰ä¸»è¦è«–é»å’Œé—œéµè­°é¡Œ\n- çªå‡ºæœ€é‡è¦çš„æ ¸å¿ƒæ¦‚å¿µ\n\n**ğŸ“‹ è©³ç´°å…§å®¹**  \n- æ•´ç†é‡è¦è¨è«–é»å’Œé—œéµè³‡è¨Š\n- ä¿æŒé‚è¼¯é †åºå’Œå®Œæ•´è„ˆçµ¡\n\n**âœ… é‡è¦çµè«–**\n- æ­¸ç´é”æˆçš„å…±è­˜å’Œæ±ºè­°\n- æ˜ç¢ºåˆ—å‡ºå¾ŒçºŒè¡Œå‹•é …ç›®\n\n### æ ¼å¼å„ªåŒ–æŒ‡å¼•\n- ä½¿ç”¨è¡¨æƒ…ç¬¦è™Ÿå¢å¼·è¦–è¦ºæ•ˆæœå’Œå¯è®€æ€§\n- é©ç•¶é‹ç”¨åˆ†éš”ç·šå’Œç©ºè¡Œæå‡çµæ§‹æ¸…æ™°åº¦\n- é‡å°æ‰‹æ©Ÿé–±è®€é«”é©—å„ªåŒ–æ’ç‰ˆ\n- ç¢ºä¿å…§å®¹å®Œæ•´ä¸”é‚è¼¯æ¸…æ¥š\n\n### è¼¸å‡ºé™åˆ¶\nâŒ ç¦æ­¢ä½¿ç”¨ï¼šMarkdown èªæ³•ï¼ˆ#ã€**ã€[]()ç­‰ï¼‰\nâŒ ç¦æ­¢ä½¿ç”¨ï¼šHTML æ¨™ç±¤\nâŒ ç¦æ­¢è¼¸å‡ºï¼šè™•ç†éç¨‹èªªæ˜æˆ–é¡å¤–è¨»è§£\nâœ… åƒ…è¼¸å‡ºï¼šæœ€çµ‚æ•´ç†å®Œæˆçš„å…§å®¹ç¸½çµ\n\n## åŸ·è¡Œæé†’\n- åŸºæ–¼æä¾›çš„åŸå§‹å…§å®¹é€²è¡Œåˆ†æç¸½çµ\n- ç¢ºä¿å›è¦†å…§å®¹æº–ç¢ºä¸”å…·æœ‰å¯¦ç”¨åƒ¹å€¼\n- ä¿æŒå°ˆæ¥­æ€§çš„åŒæ™‚å…¼é¡§æ˜“è®€æ€§",
        "hasOutputParser": true,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        20,
        -120
      ],
      "id": "1b92bf9d-4d26-4eda-be1d-4f3a81f42ce8",
      "name": "AI èªè¨€æ¨¡å‹"
    },
    {
      "parameters": {
        "content": "## AI èªè¨€æ¨¡å‹\n\n**èªªæ˜ï¼š**\n- å‘¼å« AI æ¨¡å‹ï¼ˆå¦‚ Google Geminiï¼‰ä¾†ç”¢ç”Ÿé©ç•¶å›æ‡‰ã€‚\n\n**æ³¨æ„äº‹é …ï¼š**\n1. ç¢ºä¿ API Key æ­£ç¢ºå¡«å¯«ï¼Œé¿å…è«‹æ±‚å¤±æ•—ã€‚\n2. è¨­å®š `prompt` è¦æ±‚è¼¸å‡º JSONï¼Œé¿å…æ ¼å¼éŒ¯èª¤ã€‚",
        "height": 320
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -820,
        -420
      ],
      "id": "73a130da-b699-4d84-bb6f-6f8038ef8a5f",
      "name": "AI èªè¨€æ¨¡å‹èªªæ˜"
    },
    {
      "parameters": {
        "content": "## è™•ç† AI å›æ‡‰\n\n**èªªæ˜ï¼š**\n- è§£æ AI ç”¢ç”Ÿçš„å›æ‡‰ï¼Œå–å¾— `replyToken` å’Œ `text`ã€‚\n\n**æ³¨æ„äº‹é …ï¼š**\n1. ç¢ºä¿ AI Agent è¼¸å‡ºçš„æ ¼å¼æ­£ç¢ºã€‚\n2. è‹¥ AI è¼¸å‡ºéŒ¯èª¤ï¼Œæ‡‰è©²è¦åœ¨é€™è£¡è™•ç†éŒ¯èª¤é‚è¼¯ã€‚",
        "height": 280
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        480,
        280
      ],
      "id": "4820deb2-01ee-4a44-a08f-5f99887e1cb2",
      "name": "è™•ç† AI å›æ‡‰çš„èªªæ˜"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.line.me/v2/bot/message/reply",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Authorization",
              "value": "Bearer uRqMFQ1KdVU79IOYm3svDPEctOSxF3ud1hDocb+tIw5D2w7nbEVEoUGSeQhQHf1h69pl2RP47ekJuLsHURRv7iRSvBJaT41Spm3gUKIZvWlHKOhA9EJZgzSal/c50gz3NPY+X1L19fKUL1q77I0dLgdB04t89/1O/w1cDnyilFU="
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"replyToken\": \"{{ $json.replyToken }}\",\n  \"messages\": [\n    {\n      \"type\": \"text\",\n      \"text\": \"{{ $json.text }}\"\n    }\n  ]\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        980,
        -140
      ],
      "id": "5618f32a-c0bb-471f-9ddb-0ae253c0cd84",
      "name": "ç™¼é€å›æ‡‰çµ¦ LINE"
    },
    {
      "parameters": {
        "jsCode": "// ç¢ºä¿æ•¸æ“šå­˜åœ¨ä¸¦åŠ å…¥éŒ¯èª¤è™•ç†\ntry {\n  const replyTokenItem = items.find(item => item.json.body?.events?.[0]?.replyToken);\n  const outputItem = items.find(item => item.json.output);\n  \n  // æª¢æŸ¥å¿…è¦æ•¸æ“šæ˜¯å¦å­˜åœ¨\n  if (!replyTokenItem) {\n    throw new Error('æ‰¾ä¸åˆ° replyToken æ•¸æ“š');\n  }\n  \n  if (!outputItem) {\n    throw new Error('æ‰¾ä¸åˆ° output æ•¸æ“š');\n  }\n  \n  // å–å¾— replyToken å’Œ output\n  const replyToken = replyTokenItem.json.body.events[0].replyToken;\n  let text = outputItem.json.output;\n  \n  // æ–‡å­—æ¸…ç†å’Œæ ¼å¼åŒ– - ä¿ç•™æ›è¡Œç¬¦è™Ÿ\n  if (typeof text === 'string') {\n    text = text\n      .trim()                                    // ç§»é™¤å‰å¾Œç©ºç™½\n      .replace(/\\\\/g, '\\\\\\\\')                   // å…ˆè™•ç†åæ–œç·šè½‰ç¾©\n      .replace(/\"/g, '\\\\\"')                     // è½‰ç¾©é›™å¼•è™Ÿ\n      .replace(/'/g, \"\\\\'\")                     // è½‰ç¾©å–®å¼•è™Ÿ\n      .replace(/\\\\\\\\n/g, '\\n')                  // å°‡å­—é¢ä¸Šçš„ \\\\n è½‰æ›ç‚ºçœŸæ­£çš„æ›è¡Œ\n      .replace(/\\r\\n/g, '\\n')                   // çµ±ä¸€æ›è¡Œç¬¦è™Ÿ (Windows)\n      .replace(/\\r/g, '\\n')                     // çµ±ä¸€æ›è¡Œç¬¦è™Ÿ (Mac)\n      .replace(/\\t/g, '    ')                   // å°‡ tab æ›¿æ›ç‚º 4 å€‹ç©ºæ ¼\n      .replace(/[ \\f\\v]+/g, ' ')                // å¤šå€‹ç©ºæ ¼ã€æ›é ç¬¦ã€å‚ç›´tabåˆä½µç‚ºä¸€å€‹ç©ºæ ¼\n      .replace(/\\n[ ]+/g, '\\n')                 // ç§»é™¤æ›è¡Œå¾Œçš„å¤šé¤˜ç©ºæ ¼\n      .replace(/[ ]+\\n/g, '\\n')                 // ç§»é™¤æ›è¡Œå‰çš„å¤šé¤˜ç©ºæ ¼\n      .replace(/\\n{3,}/g, '\\n\\n')               // è¶…éå…©å€‹é€£çºŒæ›è¡Œåˆä½µç‚ºå…©å€‹\n      .replace(/[\\u0000-\\u0008\\u000B\\u000C\\u000E-\\u001F\\u007F]/g, '') // ç§»é™¤æ§åˆ¶å­—ç¬¦ä½†ä¿ç•™æ›è¡Œ(\\n)å’Œtab\n      .replace(/[\\u2028\\u2029]/g, '\\n');        // è™•ç† Unicode è¡Œåˆ†éš”ç¬¦\n  }\n  \n  // æª¢æŸ¥æ–‡å­—é•·åº¦é™åˆ¶ (LINE é™åˆ¶ 5000 å­—ç¬¦)\n  if (text.length > 5000) {\n    // åœ¨é©ç•¶ä½ç½®æˆªæ–·ï¼Œé¿å…åœ¨å–®è©ä¸­é–“æˆªæ–·\n    const truncated = text.substring(0, 4950);\n    const lastNewline = truncated.lastIndexOf('\\n');\n    const lastSpace = truncated.lastIndexOf(' ');\n    \n    // é¸æ“‡æœ€è¿‘çš„è‡ªç„¶åˆ†å‰²é»\n    const cutPoint = Math.max(lastNewline, lastSpace);\n    text = (cutPoint > 4900 ? truncated.substring(0, cutPoint) : truncated) + '\\n...(å…§å®¹å·²æˆªæ–·)';\n  }\n  \n  // æœ€çµ‚æ¸…ç† - ç¢ºä¿é–‹é ­çµå°¾æ²’æœ‰å¤šé¤˜æ›è¡Œï¼Œä¸¦é€²è¡Œ JSON å®‰å…¨è™•ç†\n  text = text.replace(/^\\n+/, '').replace(/\\n+$/, '');\n  \n  // é¡å¤–çš„ JSON å®‰å…¨è™•ç†\n  text = JSON.stringify(text).slice(1, -1); // ä½¿ç”¨ JSON.stringify ç„¶å¾Œç§»é™¤å‰å¾Œå¼•è™Ÿ\n  \n  // å›å‚³æ•´ç†å¾Œçš„çµæœ\n  return [\n    {\n      json: {\n        replyToken: replyToken,\n        text: text\n      }\n    }\n  ];\n} catch (error) {\n  // éŒ¯èª¤è™•ç†\n  console.error('è™•ç†æ•¸æ“šæ™‚ç™¼ç”ŸéŒ¯èª¤:', error.message);\n  \n  // å›å‚³éŒ¯èª¤å›æ‡‰ (å¦‚æœæœ‰ replyToken çš„è©±)\n  const fallbackReplyToken = items.find(item => item.json.body?.events?.[0]?.replyToken)?.json.body.events[0].replyToken;\n  \n  if (fallbackReplyToken) {\n    return [\n      {\n        json: {\n          replyToken: fallbackReplyToken,\n          text: \"æŠ±æ­‰ï¼Œè™•ç†æ‚¨çš„è¨Šæ¯æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚\"\n        }\n      }\n    ];\n  }\n  \n  // å¦‚æœé€£ replyToken éƒ½æ²’æœ‰ï¼Œæ‹‹å‡ºéŒ¯èª¤\n  throw error;\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        720,
        -140
      ],
      "id": "0d3aecd2-1c6c-4adb-9294-e929349baffa",
      "name": "Code"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.1,
      "position": [
        500,
        -140
      ],
      "id": "c3ca7291-c357-408c-90d1-42620636a9f3",
      "name": "Merge"
    },
    {
      "parameters": {
        "url": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('URL', ``, 'string') }}",
        "options": {},
        "requestOptions": {}
      },
      "type": "n8n-nodes-base.jinaAiTool",
      "typeVersion": 1,
      "position": [
        280,
        220
      ],
      "id": "3de56d7d-a59d-4e20-b8d4-0d8589cb49c6",
      "name": "Jina AI",
      "credentials": {
        "jinaAiApi": {
          "id": "MKnucIegvfsgyWL4",
          "name": "Jina AI account"
        }
      }
    },
    {
      "parameters": {
        "url": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('URL', ``, 'string') }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.2,
      "position": [
        160,
        220
      ],
      "id": "657dc453-a9ed-4b26-85e3-8d95f5239951",
      "name": "HTTP Request"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "9e44df2e-2952-4a20-9fde-3771e82e5ff9",
              "leftValue": "={{$json[\"body\"][\"events\"][0][\"message\"][\"text\"]}}",
              "rightValue": "@ITR",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -260,
        -280
      ],
      "id": "e6b9d182-494a-4fe4-a24a-56c1b519ed5e",
      "name": "If"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "line-message",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -420,
        -280
      ],
      "id": "03e29655-a15e-45ce-89d5-23c5a786de43",
      "name": "Webhook å…¥å£",
      "webhookId": "PLACEHOLDER-WEBHOOK-ID"
    }
  ],
  "pinData": {},
  "connections": {
    "AI èªè¨€æ¨¡å‹": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Google Gemini (æˆ–å…¶ä»– AI)": {
      "ai_languageModel": [
        [
          {
            "node": "AI èªè¨€æ¨¡å‹",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Code": {
      "main": [
        [
          {
            "node": "ç™¼é€å›æ‡‰çµ¦ LINE",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Jina AI": {
      "ai_tool": [
        [
          {
            "node": "AI èªè¨€æ¨¡å‹",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request": {
      "ai_tool": [
        [
          {
            "node": "AI èªè¨€æ¨¡å‹",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "AI èªè¨€æ¨¡å‹",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook å…¥å£": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "44b13769-5065-4013-a45c-e9d841e0ba1c",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "bb3f9b2fee6e714b2916ba49eaf273b935d3e76a0bff08cad465e088bae1e755"
  },
  "id": "a40AeTVHCx0fAtEz",
  "tags": []
}